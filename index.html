<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính Lương (Chốt ngày 20)</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-radius: 12px;
            --success-color: #10b981; /* Màu xanh thành công */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1, h2 { text-align: center; color: #111827; margin-bottom: 10px; }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input[type="date"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fff;
        }

        /* Phần hiển thị tạm tính */
        .result-box {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .result-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: #dc2626;
            border-top: 1px dashed #cbd5e1;
            padding-top: 8px;
            margin-top: 8px;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease; /* Hiệu ứng mượt */
            margin-top: 10px;
        }

        button:active { transform: scale(0.98); } /* Nhấn vào nút hơi lún xuống */
        
        .btn-delete {
            background-color: #ef4444;
            padding: 8px;
            font-size: 0.9rem;
            margin-top: 20px;
        }
        .btn-delete:hover { background-color: #dc2626; }

        /* Bảng lịch sử */
        .history-controls {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th { background-color: #f8fafc; }

        .badge-ot {
            background-color: #fef3c7;
            color: #d97706;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .period-info {
            text-align: center;
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Tính Lương 1225¥</h1>

    <div class="card">
        <div class="input-group">
            <label>Ngày làm việc</label>
            <input type="date" id="workDate" onchange="saveOrUpdateEntry()">
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="input-group" style="flex:1">
                <label>Vào Ca</label>
                <input type="time" id="startTime" onchange="saveOrUpdateEntry()">
            </div>
            <div class="input-group" style="flex:1">
                <label>Tan Ca</label>
                <input type="time" id="endTime" onchange="saveOrUpdateEntry()">
            </div>
        </div>

        <div class="input-group">
            <label>Thời gian nghỉ (phút)</label>
            <input type="number" id="breakTime" value="60" oninput="saveOrUpdateEntry()">
            <small style="color: #6b7280;">Trừ lương thời gian này (Mặc định 60p)</small>
        </div>

        <div class="result-box">
            <div class="result-row">
                <span>Giờ làm thực tế:</span>
                <span id="previewNetWork" style="font-weight: bold;">0 giờ</span>
            </div>
            <div class="result-row">
                <span>OT (sau 8h):</span>
                <span id="previewOT" class="badge-ot">0h</span>
            </div>
            <div class="result-row result-total">
                <span>Lương hôm nay:</span>
                <span id="previewSalary">¥0</span>
            </div>
        </div>

        <button id="btnSave" onclick="showSaveFeedback()">+ Lưu Ngày Công</button>
    </div>

    <div class="card">
        <h2>Bảng Lương Tháng</h2>
        
        <div class="history-controls">
            <label>Chọn tháng nhận lương:</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="monthSelector" onchange="renderHistory()" style="font-weight:bold; color:#2563eb;">
                    </select>
            </div>
            <div class="period-info" id="periodDisplay">
                (Kỳ: 21/xx - 20/xx)
            </div>
        </div>

        <div style="display:flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
            <div>
                <small>Tổng Giờ</small><br>
                <strong id="totalHoursMonth">0h</strong>
            </div>
            <div>
                <small>Tổng OT</small><br>
                <strong id="totalOTMonth" style="color: #d97706;">0h</strong>
            </div>
            <div style="text-align: right;">
                <small>TỔNG LĨNH</small><br>
                <strong id="totalMoneyMonth" style="color: #dc2626; font-size: 1.4rem;">¥0</strong>
            </div>
        </div>

        <table id="historyTable">
            <thead>
                <tr>
                    <th>Ngày</th>
                    <th>Giờ làm</th>
                    <th>Tiền</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        
        <button class="btn-delete" onclick="clearAllData()">Xóa TẤT CẢ dữ liệu lịch sử</button>
    </div>
</div>

<script>
    // === CẤU HÌNH ===
    const BASE_RATE = 1225; // Lương cơ bản
    const OT_RATE = 1.25;   // Hệ số OT
    
    // Khởi tạo ngày hôm nay cho ô nhập liệu
    document.getElementById('workDate').valueAsDate = new Date();

    // Load dữ liệu cũ
    let workHistory = JSON.parse(localStorage.getItem('salaryApp_v2_history')) || [];
    
    // Khởi tạo Select box chọn tháng
    initMonthSelector();
    
    // Render lần đầu
    renderHistory();

    // === CÁC HÀM TÍNH TOÁN ===

    function calculateSalary(start, end, breakMins) {
        let startTime = new Date(`2000-01-01T${start}`);
        let endTime = new Date(`2000-01-01T${end}`);
        
        // Xử lý làm qua đêm
        if (endTime < startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }

        let diffMs = endTime - startTime;
        let totalSpanMinutes = Math.floor(diffMs / 60000); 
        
        // Giờ làm thực = Tổng thời gian ở cty - Giờ nghỉ
        let netWorkMinutes = totalSpanMinutes - breakMins;
        if (netWorkMinutes < 0) netWorkMinutes = 0;

        // Tách OT: Sau 8 tiếng (480 phút) tính OT
        let normalMinutes = 0;
        let otMinutes = 0;

        if (netWorkMinutes > 480) {
            normalMinutes = 480; 
            otMinutes = netWorkMinutes - 480; 
        } else {
            normalMinutes = netWorkMinutes;
            otMinutes = 0;
        }

        // Tính tiền
        let payNormal = (normalMinutes / 60) * BASE_RATE;
        let payOT = (otMinutes / 60) * BASE_RATE * OT_RATE;
        let totalSalary = Math.round(payNormal + payOT);

        return { netWorkMinutes, otMinutes, totalSalary };
    }

    // === HÀM LƯU / CẬP NHẬT CHÍNH (AUTO-SAVE) ===

    function saveOrUpdateEntry() {
        const date = document.getElementById('workDate').value;
        const start = document.getElementById('startTime').value;
        const end = document.getElementById('endTime').value;
        const breakMins = parseInt(document.getElementById('breakTime').value) || 0;

        // 1. Tính toán và cập nhật Preview (chỉ cần start và end là tính được)
        let calc = null;
        if (start && end) {
            calc = calculateSalary(start, end, breakMins);
            document.getElementById('previewNetWork').innerText = formatMinutes(calc.netWorkMinutes);
            document.getElementById('previewOT').innerText = formatMinutes(calc.otMinutes);
            document.getElementById('previewSalary').innerText = formatCurrency(calc.totalSalary);
        } else {
            // Reset preview nếu thiếu giờ
            document.getElementById('previewNetWork').innerText = '0 giờ';
            document.getElementById('previewOT').innerText = '0h';
            document.getElementById('previewSalary').innerText = '¥0';
        }
        
        // 2. KIỂM TRA BẮT BUỘC TRƯỚC KHI LƯU (Chỉ lưu khi có đủ 3 inputs chính)
        if (!date || !start || !end) {
            return; // Dừng lại, không lưu, không báo lỗi
        }

        // 3. Chuẩn bị data
        const existingIndex = workHistory.findIndex(item => item.date === date);

        const newEntry = {
            id: existingIndex !== -1 ? workHistory[existingIndex].id : Date.now(),
            date: date,
            start: start,
            end: end,
            breakMins: breakMins,
            netWorkMinutes: calc.netWorkMinutes,
            otMinutes: calc.otMinutes,
            salary: calc.totalSalary
        };

        if (existingIndex !== -1) {
            // Cập nhật lại entry cũ
            workHistory[existingIndex] = newEntry;
        } else {
            // Thêm mới
            workHistory.push(newEntry);
        }

        // 4. Lưu, Render và Feedback
        workHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
        saveData();
        renderHistory(); 
        showSaveFeedback(); // Hiện hiệu ứng đã lưu
    }
    
    function showSaveFeedback() {
        // Chỉ hiện feedback khi các input đã có đủ dữ liệu
        const date = document.getElementById('workDate').value;
        const start = document.getElementById('startTime').value;
        const end = document.getElementById('endTime').value;
        if (!date || !start || !end) return;

        const btn = document.getElementById('btnSave');
        const originalText = btn.innerText;
        
        if (btn.innerText.includes('Đã lưu')) return;
        
        btn.innerText = "✅ Đã lưu!";
        btn.style.backgroundColor = "#10b981";
        
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.backgroundColor = ""; 
        }, 1000);
    }
    
    // === XỬ LÝ LỊCH SỬ VÀ KỲ LƯƠNG ===

    function initMonthSelector() {
        const select = document.getElementById('monthSelector');
        select.innerHTML = '';
        
        const today = new Date();
        const currentMonth = today.getMonth() + 1; 
        const currentYear = today.getFullYear();
        const currentDay = today.getDate();

        let targetMonth = currentDay <= 20 ? currentMonth : currentMonth + 1;
        let targetYear = currentYear;
        
        if (targetMonth > 12) {
            targetMonth = 1;
            targetYear++;
        }

        for (let i = -6; i <= 6; i++) {
            let m = targetMonth + i;
            let y = targetYear;
            while (m > 12) { m -= 12; y++; }
            while (m < 1) { m += 12; y--; }

            const option = document.createElement('option');
            option.value = `${y}-${m.toString().padStart(2, '0')}`;
            option.text = `Tháng ${m}/${y}`;
            if (i === 0) option.selected = true;
            select.appendChild(option);
        }
    }

    function getPayPeriod(yearMonthString) {
        const [y, m] = yearMonthString.split('-').map(Number);
        const endDate = new Date(y, m - 1, 20); 
        const startDate = new Date(y, m - 2, 21);
        return { startDate, endDate };
    }

    function renderHistory() {
        const selectedValue = document.getElementById('monthSelector').value;
        const { startDate, endDate } = getPayPeriod(selectedValue);

        document.getElementById('periodDisplay').innerText = 
            `(Kỳ tính: ${formatDateSimple(startDate)} - ${formatDateSimple(endDate)})`;

        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        let totalMoney = 0;
        let totalMinutes = 0;
        let totalOT = 0;

        const filteredList = workHistory.filter(item => {
            const itemDate = new Date(item.date);
            const d = new Date(itemDate).setHours(0,0,0,0);
            const s = new Date(startDate).setHours(0,0,0,0);
            const e = new Date(endDate).setHours(0,0,0,0);
            return d >= s && d <= e;
        });

        if (filteredList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Chưa có dữ liệu trong kỳ này</td></tr>';
        }

        filteredList.forEach(item => {
            totalMoney += item.salary;
            totalMinutes += item.netWorkMinutes;
            totalOT += item.otMinutes;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <strong>${formatDate(item.date)}</strong><br>
                    <small style="color:#666">${item.start}-${item.end}</small>
                </td>
                <td>
                    ${formatMinutes(item.netWorkMinutes)}<br>
                    ${item.otMinutes > 0 ? `<span class="badge-ot">OT: ${formatMinutes(item.otMinutes)}</span>` : ''}
                </td>
                <td style="font-weight:bold; color:#2563eb;">
                    ${formatCurrency(item.salary)}
                </td>
                <td>
                    <button onclick="deleteEntry(${item.id})" style="background:none; border:none; color:#ef4444; font-weight:bold; padding:5px; margin:0; cursor:pointer;">Xóa</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('totalMoneyMonth').innerText = formatCurrency(totalMoney);
        document.getElementById('totalHoursMonth').innerText = formatMinutes(totalMinutes);
        document.getElementById('totalOTMonth').innerText = formatMinutes(totalOT);
    }

    function deleteEntry(id) {
        if(confirm("Xóa dòng này?")) {
            workHistory = workHistory.filter(item => item.id !== id);
            saveData();
            renderHistory();
        }
    }

    function clearAllData() {
        if(confirm("CẢNH BÁO: Xóa toàn bộ lịch sử?")) {
            workHistory = [];
            saveData();
            renderHistory();
        }
    }

    function saveData() {
        localStorage.setItem('salaryApp_v2_history', JSON.stringify(workHistory));
    }

    function formatCurrency(num) {
        return '¥' + num.toLocaleString('ja-JP');
    }

    function formatMinutes(mins) {
        if (mins === 0) return '0';
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return h > 0 ? `${h}h${m > 0 ? m : ''}` : `${m}p`;
    }

    function formatDate(dateString) {
        const [y, m, d] = dateString.split('-');
        return `${d}/${m}`;
    }

    function formatDateSimple(dateObj) {
        return `${dateObj.getDate()}/${dateObj.getMonth() + 1}`;
    }
</script>

</body>
</html>
